
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // --- Safe Role Checking Functions ---
    
    function userDocExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function hasRole(role) {
      return request.auth != null
        && userDocExists()
        && getUserRole() == role;
    }

    function isReferralPartner() {
      return hasRole('referral-partner');
    }

    function isSalesTeam() {
      let role = getUserRole();
      return role == 'sales-team' || role == 'sales-manager';
    }

    function isSalesManager() {
        return hasRole('sales-manager');
    }
    
    function isSalesTeamAssigned(assignedSalesId) {
        return isSalesTeam() && request.auth.uid == assignedSalesId;
    }

    function isAdmin() {
      return hasRole('admin');
    }
    
    function isWritingTeam() {
      return hasRole('writing-team');
    }
    
    function isWriterAssigned(writerId) {
        return isWritingTeam() && request.auth.uid == writerId;
    }
    
    function isProjectAssignedToClient(projectId) {
        return get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid;
    }

    function isAllowedToCreateOwnProfile(userId) {
      let isCreatingOwnDoc = request.auth != null && request.auth.uid == userId;
      let data = request.resource.data;
      let isValidRole = data.role == 'client' || data.role == 'referral-partner';
      let uidMatches = data.uid == request.auth.uid;

      return isCreatingOwnDoc && isValidRole && uidMatches;
    }
    
    function isClientCreatingOwnProject() {
        let data = request.resource.data;
        // List of fields a client is ALLOWED to set on creation.
        let allowedKeys = [
            'userId', 'title', 'mobile', 'serviceType', 'topic', 'courseLevel', 'deadline',
            'referencingStyle', 'pageCount', 'wordCount', 'language', 'wantToPublish',
            'publishWhere', 'status', 'createdAt', 'updatedAt', 'assignedSalesId'
        ];
        
        let isCreatingOwnProject = request.auth != null && request.auth.uid == data.userId;
        let onlyAllowedFields = data.keys().hasOnly(allowedKeys);
        
        return isCreatingOwnProject && onlyAllowedFields && data.status == 'pending';
    }


    match /users/{userId} {
      allow create: if isAllowedToCreateOwnProfile(userId) || isAdmin();
      allow read: if isOwner(userId) 
                    || isAdmin() 
                    || isSalesTeam() 
                    || isWritingTeam()
                    || (resource.data.role in ['sales-team', 'sales-manager']) // This allows clients to read salesperson profiles
                    || (isReferralPartner() && resource.data.referredBy == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.referralCode);
      
      allow list: if request.auth != null && (
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in 
                    ['admin', 'sales-manager', 'sales-team', 'writing-team', 'referral-partner']
                  );

      allow update: if (isOwner(userId) || isAdmin()) && request.resource.data.role == resource.data.role;
      allow delete: if isAdmin();
    }
    
    match /projects/{projectId} {
      allow create: if isClientCreatingOwnProject() || isSalesTeam() || isSalesManager() || isAdmin();
      allow read: if isOwner(resource.data.userId) || isAdmin() || isSalesTeam() || isWriterAssigned(resource.data.assignedWriterId);
      allow update: if isOwner(resource.data.userId) || isAdmin() || isSalesTeam() || (isWriterAssigned(resource.data.assignedWriterId) && request.resource.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']) && request.resource.data.status == 'completed');
      allow delete: if isOwner(resource.data.userId) || isAdmin();
      allow list: if request.auth != null && (isAdmin() || isSalesManager() || isSalesTeam() || (isOwner(request.query.where.userId)));
    }
    
    match /contact_leads/{contactLeadId} {
      allow create: if true;
      allow read, list: if isAdmin() || isSalesTeam() || (isReferralPartner() && resource.data.referredByPartnerId == request.auth.uid);
      allow update: if isSalesTeam();
      allow delete: if false;
    }

    match /testimonials/{testimonialId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /referrals/{referralId} {
        allow create: if isReferralPartner() && request.resource.data.partnerId == request.auth.uid;
        allow read, list: if (isReferralPartner() && resource.data.partnerId == request.auth.uid) || isAdmin();
        allow update, delete: if isAdmin();
    }

    match /payouts/{payoutId} {
      allow create: if isReferralPartner() && request.resource.data.userId == request.auth.uid;
      allow read, list: if (isReferralPartner() && resource.data.userId == request.auth.uid) || isAdmin() || isSalesTeam();
      allow update, delete: if isAdmin();
    }

    match /marketing_assets/{assetId} {
        allow create, update, delete: if isAdmin() && request.resource.data.category in ['demo-thesis', 'demo-synopsis', 'general-marketing'];
        allow read, list: if request.auth != null;
    }

    match /feedbacks/{feedbackId} {
      allow create: if request.resource.data.status == 'pending';
      allow update, delete: if isAdmin();
      allow read: if isAdmin() || resource.data.status == 'approved';
      allow list: if isAdmin() || (request.query.where.get('status') == 'approved');
    }
    
    match /mail/{docId} {
        allow create: if request.auth != null;
        allow read, update, delete: if false;
    }
    
    match /tasks/{taskId} {
      allow read, list: if isAdmin() || isWritingTeam();
      allow create, update, delete: if isAdmin() || isWritingTeam();
    }

    match /book_sales/{saleId} {
      allow read, write, create, list, update, delete: if isAdmin() || isSalesTeam();
    }

    match /invoices/{invoiceId} {
      allow read, write, create, list, update, delete: if isAdmin() || isSalesTeam();
    }

    match /notifications/{notificationId} {
       allow read, write, create, list, update, delete: if isAdmin() || (isOwner(resource.data.userId));
    }
    
    match /metadata/{docId} {
        allow read, write: if isAdmin() || isSalesManager() || isSalesTeam() || isReferralPartner();
    }

    match /chats/{chatId} {
      // A user can create a chat if they are one of the participants.
      // A user can update participant names.
      allow create, update: if request.auth.uid in request.resource.data.participants;
      
      // A user can read a chat if they are a participant. Sales manager can list all chats.
      allow read: if request.auth.uid in resource.data.participants;
      allow list: if isSalesManager();

      // Nobody can delete a chat history for now.
      allow delete: if false;

      match /messages/{messageId} {
        // A user can read/list messages if they are a participant of the parent chat.
        allow read, list: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // A user can create a message if they are a participant and the senderId is their own UID.
        allow create: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
                      && request.auth.uid == request.resource.data.senderId;
                      
        // Nobody can update or delete messages.
        allow update, delete: if false;
      }
    }
  }
}
